---
import MainLayout from '../../layouts/MainLayout.astro';
---
<MainLayout title="Edit Your Profile - DivineX">
  <div class="profile-page">
    <!-- Main Profile Form -->
    <form id="profile-form" class="profile-form">
      <h1>Edit Your Profile</h1>
      <p id="page-subtitle">Initializing...</p>
      
      <div id="main-form-fields" style="display: none; width: 100%; display: flex; flex-direction: column; gap: 1rem;">
        <input type="hidden" id="profile-id" />
        <input type="hidden" name="profile_picture_url" id="profile-picture-url" />
        
        <label>Username <input type="text" name="username" id="username" required /></label>
        <label>Profession
          <select name="profession" id="profession" required>
            <option value="Brand Designer">Brand Designer</option>
            <option value="UI/UX Designer">UI/UX Designer</option>
            <option value="Developer">Developer</option>
            <option value="Product Manager">Product Manager</option>
            <option value="Illustrator">Illustrator</option>
            <option value="Photographer">Photographer</option>
            <option value="Combo Deals">Combo Deals</option>
          </select>
        </label>
        <label>Bio <textarea name="bio" id="bio" rows="4" required></textarea></label>
        <label>Contact Link (Optional) <input type="url" name="contact_link" id="contact_link" /></label>
        <label>Replace Profile Picture (Optional) <input type="file" id="avatar-upload" accept="image/*" /></label>
        <div class="image-preview-wrapper">
          <span>Current:</span>
          <img src="" alt="Current profile picture" id="image-preview" class="image-preview" />
        </div>
        <div class="form-actions">
          <button type="submit" id="submit-btn" class="btn btn-primary">Save Profile Changes</button>
        </div>
        <div id="form-status"></div>
      </div>
    </form>

    <!-- !!! NEW: Manage Projects Section !!! -->
    <div id="projects-section" class="projects-section" style="display: none;">
      <h2>Manage Projects</h2>
      <div id="projects-grid" class="projects-grid">
        <!-- Project cards will be injected here by JavaScript -->
      </div>
      <button id="add-project-btn" class="btn btn-secondary">Add New Project</button>
    </div>

    <!-- !!! NEW: Modal for Adding/Editing a Project !!! -->
    <div id="project-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h3 id="modal-title">Add New Project</h3>
        <form id="project-form">
          <input type="hidden" id="project-id" />
          <input type="hidden" id="project-image-url" />
          <label>Title <input type="text" id="project-title" required /></label>
          <label>Description <textarea id="project-description" rows="3"></textarea></label>
          <label>Image <input type="file" id="project-image-upload" accept="image/*" /></label>
          <img id="project-image-preview" src="" class="image-preview" style="display:none;" />
          <div class="modal-actions">
            <button type="button" id="delete-project-btn" class="btn btn-danger" style="display:none;">Delete</button>
            <div style="flex-grow: 1;"></div>
            <button type="button" id="cancel-project-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" id="save-project-btn" class="btn btn-primary">Save Project</button>
          </div>
          <div id="modal-status"></div>
        </form>
      </div>
    </div>
  </div>
</MainLayout>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let userProfile = null;
  let tg = null;

  // --- Element Selectors for Main Profile ---
  const profileForm = document.getElementById('profile-form');
  const pageSubtitle = document.getElementById('page-subtitle');
  const mainFormFields = document.getElementById('main-form-fields');
  const profileIdInput = document.getElementById('profile-id');
  const usernameInput = document.getElementById('username');
  const professionInput = document.getElementById('profession');
  const bioInput = document.getElementById('bio');
  const contactLinkInput = document.getElementById('contact_link');
  const avatarUpload = document.getElementById('avatar-upload');
  const profilePictureUrlInput = document.getElementById('profile-picture-url');
  const imagePreview = document.getElementById('image-preview');
  const profileFormStatus = document.getElementById('form-status');
  const profileSubmitBtn = document.getElementById('submit-btn');

  // --- Element Selectors for Projects ---
  const projectsSection = document.getElementById('projects-section');
  const projectsGrid = document.getElementById('projects-grid');
  const addProjectBtn = document.getElementById('add-project-btn');

  // --- Element Selectors for Project Modal ---
  const projectModal = document.getElementById('project-modal');
  const modalTitle = document.getElementById('modal-title');
  const projectForm = document.getElementById('project-form');
  const projectIdInput = document.getElementById('project-id');
  const projectImageUrlInput = document.getElementById('project-image-url');
  const projectTitleInput = document.getElementById('project-title');
  const projectDescriptionInput = document.getElementById('project-description');
  const projectImageUpload = document.getElementById('project-image-upload');
  const projectImagePreview = document.getElementById('project-image-preview');
  const cancelProjectBtn = document.getElementById('cancel-project-btn');
  const saveProjectBtn = document.getElementById('save-project-btn');
  const deleteProjectBtn = document.getElementById('delete-project-btn');
  const modalStatus = document.getElementById('modal-status');
  
  // --- Main Initialization ---
  function initializeApp() {
    if (!window.Telegram?.WebApp?.initData) {
      setTimeout(initializeApp, 50);
      return;
    }
    tg = window.Telegram.WebApp;
    tg.ready();
    fetchProfileAndProjects();
    addEventListeners();
  }

  // --- Data Fetching ---
  async function fetchProfileAndProjects() {
    pageSubtitle.textContent = "Loading your data...";
    try {
      const response = await fetch('/api/profiles/me-with-projects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: tg.initData }),
      });
      if (!response.ok) throw new Error('Could not fetch profile and projects.');
      const data = await response.json();
      userProfile = data.profile;
      
      populateProfileForm();
      renderProjects();
      
      mainFormFields.style.display = 'flex';
      projectsSection.style.display = 'block';
      pageSubtitle.textContent = 'Update your public information.';
    } catch (err) {
      pageSubtitle.textContent = `Error: ${err.message}`;
    }
  }

  // --- UI Rendering ---
  function populateProfileForm() {
    profileIdInput.value = userProfile.id;
    usernameInput.value = userProfile.username || '';
    professionInput.value = userProfile.profession || '';
    bioInput.value = userProfile.bio || '';
    contactLinkInput.value = userProfile.contact_link || '';
    profilePictureUrlInput.value = userProfile.profile_picture_url || '';
    imagePreview.src = userProfile.profile_picture_url || '/default-avatar.png';
  }

  function renderProjects() {
    projectsGrid.innerHTML = ''; // Clear existing projects
    userProfile.projects.forEach(project => {
      const card = document.createElement('div');
      card.className = 'project-card-edit';
      // !!! FIX #1: Added a specific class 'project-avatar-edit' to the image tag !!!
      card.innerHTML = `
        <img src="${project.image_url || '/default-avatar.png'}" alt="${project.title}" class="project-avatar-edit" />
        <div class="project-card-info">
          <h4>${project.title}</h4>
        </div>
      `;
      card.addEventListener('click', () => openProjectModal(project));
      projectsGrid.appendChild(card);
    });
    addProjectBtn.disabled = userProfile.projects.length >= 4;
  }

  function openProjectModal(project = null) {
    projectForm.reset();
    modalStatus.textContent = '';
    projectImagePreview.style.display = 'none';
    projectImagePreview.src = '';

    if (project) { // Editing existing project
      modalTitle.textContent = 'Edit Project';
      projectIdInput.value = project.id;
      projectImageUrlInput.value = project.image_url || '';
      projectTitleInput.value = project.title;
      projectDescriptionInput.value = project.description;
      if (project.image_url) {
        projectImagePreview.src = project.image_url;
        projectImagePreview.style.display = 'block';
      }
      deleteProjectBtn.style.display = 'block';
    } else { // Adding new project
      modalTitle.textContent = 'Add New Project';
      projectIdInput.value = '';
      projectImageUrlInput.value = '';
      deleteProjectBtn.style.display = 'none';
    }
    projectModal.style.display = 'flex';
  }

  function closeProjectModal() {
    projectModal.style.display = 'none';
  }
  
  async function uploadFile(file, endpoint) {
    const response = await fetch(endpoint, {
      method: 'POST', body: file, headers: { 'Content-Type': file.type }
    });
    if (!response.ok) throw new Error('Upload failed.');
    return (await response.json()).url;
  }
  
  // --- Event Handlers ---
  async function handleProfileUpdate(e) {
    e.preventDefault();
    profileSubmitBtn.disabled = true;
    profileFormStatus.textContent = 'Processing...';

    const newImageFile = avatarUpload.files?.[0];

    try {
      if (newImageFile) {
        profileFormStatus.textContent = 'Uploading new profile picture...';
        const uploadedImageUrl = await uploadFile(newImageFile, '/api/profiles/upload');
        profilePictureUrlInput.value = uploadedImageUrl;
      }
      
      profileFormStatus.textContent = 'Saving profile changes...';
      const formData = new FormData(profileForm);
      const updatedData = {
        username: formData.get('username'),
        bio: formData.get('bio'),
        contact_link: formData.get('contact_link'),
        profession: formData.get('profession'),
        profile_picture_url: profilePictureUrlInput.value,
        initData: tg.initData,
      };

      const response = await fetch('/api/profiles/update', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData),
      });
      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.error || 'Failed to save changes.');
      }

      alert('Profile updated successfully!');
    } catch (err) {
      alert(`Failed to save profile: ${err.message}`);
    } finally {
      profileSubmitBtn.disabled = false;
      profileFormStatus.textContent = '';
    }
  }

  async function handleProjectSave(e) {
    e.preventDefault();
    saveProjectBtn.disabled = true;
    modalStatus.textContent = 'Saving...';
    try {
      let imageUrl = projectImageUrlInput.value;
      const imageFile = projectImageUpload.files[0];
      if (imageFile) {
        modalStatus.textContent = 'Uploading project image...';
        imageUrl = await uploadFile(imageFile, '/api/projects/upload');
      }

      if (!imageUrl) {
        throw new Error('An image is required for a project.');
      }

      const isEditing = !!projectIdInput.value;
      const endpoint = isEditing ? '/api/projects/update' : '/api/projects/create';
      const payload = {
        initData: tg.initData,
        profile_id: userProfile.id,
        project_id: isEditing ? projectIdInput.value : undefined,
        title: projectTitleInput.value,
        description: projectDescriptionInput.value,
        image_url: imageUrl,
      };

      const response = await fetch(endpoint, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.error || 'Failed to save project.');
      }
      
      await fetchProfileAndProjects(); // Refresh all data
      closeProjectModal();
    } catch (err) {
      modalStatus.textContent = `Error: ${err.message}`;
    } finally {
      saveProjectBtn.disabled = false;
    }
  }

  async function handleDeleteProject() {
    if (!confirm('Are you sure you want to delete this project?')) return;
    deleteProjectBtn.disabled = true;
    modalStatus.textContent = 'Deleting...';
    try {
      const response = await fetch('/api/projects/delete', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: tg.initData, project_id: projectIdInput.value })
      });
      if (!response.ok) throw new Error('Failed to delete project.');

      await fetchProfileAndProjects(); // Refresh all data
      closeProjectModal();
    } catch (err) {
      modalStatus.textContent = `Error: ${err.message}`;
    } finally {
      deleteProjectBtn.disabled = false;
    }
  }

  function addEventListeners() {
    profileForm.addEventListener('submit', handleProfileUpdate);
    addProjectBtn.addEventListener('click', () => openProjectModal());
    cancelProjectBtn.addEventListener('click', closeProjectModal);
    projectForm.addEventListener('submit', handleProjectSave);
    deleteProjectBtn.addEventListener('click', handleDeleteProject);
  }

  initializeApp();
});
</script>
<style>
  .profile-page { max-width: 600px; margin: 0 auto; }
  .profile-form h1 { font-size: 2rem; }
  #page-subtitle { color: var(--hint-color); }
  .profile-form { display: flex; flex-direction: column; gap: 1rem; background-color: var(--secondary-bg-color); padding: 1.5rem; border-radius: 16px; margin-top: 2rem; }
  .profile-form label { font-weight: 500; display: flex; flex-direction: column; gap: 0.25rem; }
  .profile-form input, .profile-form textarea, .profile-form select {
    width: 100%; padding: 0.75rem; font-size: 1rem; border-radius: 8px;
    border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color);
  }
  .image-preview-wrapper { display: flex; align-items: center; gap: 1rem; font-size: 0.9em; color: var(--hint-color); }
  .image-preview { height: 50px; width: 50px; border-radius: 8px; object-fit: cover; }
  .form-actions { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1rem; }
  .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background-color: var(--brand-color); color: var(--button-text-color); }
  .btn-secondary { background-color: var(--secondary-bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
  .btn-danger { background-color: #e53e3e; color: white; }
  #form-status { font-size: 0.9rem; color: var(--hint-color); text-align: center; flex-grow: 1; }
  .projects-section { margin-top: 3rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
  .projects-section h2 { font-size: 1.5rem; margin-bottom: 1.5rem; }
  
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  @media (min-width: 768px) {
    .projects-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .project-card-edit {
    background-color: var(--bg-color); /* Change to main background for a cleaner look */
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    border: 1px solid var(--border-color);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* Center content vertically */
  }
  .project-card-edit:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* !!! FIX #2: The new CSS class to make the image circular !!! */
  .project-avatar-edit {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 0.75rem;
    border: 2px solid var(--bg-color);
    background-color: var(--border-color);
  }
  
  /* Remove the old, incorrect rule */
  .project-card-edit img {
    /* This rule is no longer needed, the one above is more specific */
  }

  .project-card-info {
    padding: 0; /* No extra padding needed */
  }
  .project-card-info h4 {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-color);
    width: 100%;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
  .modal-content { background-color: var(--bg-color); border-radius: 16px; padding: 2rem; width: 90%; max-width: 500px; }
  .modal-content h3 { margin-top: 0; }
  #project-form { display: flex; flex-direction: column; gap: 1rem; }
  .modal-actions { display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem; }
  #modal-status { font-size: 0.9rem; color: var(--hint-color); }
</style>