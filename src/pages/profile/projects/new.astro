---
import MainLayout from '../../../layouts/MainLayout.astro';
---
<MainLayout title="Add New Project - DivineX">
  <div class="profile-page">
    <div class="back-link-wrapper">
      <a href="/profile/edit" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><polyline points="12 19 5 12 12 5"></polyline></svg>
        <span>Back to Edit Profile</span>
      </a>
    </div>

    <h1>Add New Project</h1>
    <form id="add-project-form" class="profile-form">
      <label>Project Title <input type="text" name="title" required /></label>
      <label>Project Description <textarea name="description" rows="4"></textarea></label>
      <label>Project Image <input type="file" name="image" accept="image/*" required /></label>
      <div class="form-actions">
        <button type="submit" id="submit-btn" class="btn btn-primary">Add Project</button>
      </div>
      <div id="form-status"></div>
    </form>
  </div>
</MainLayout>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram?.WebApp;
    const pageSubtitle = document.getElementById('page-subtitle');
    if (!tg?.initData) {
      if (pageSubtitle) pageSubtitle.textContent = "This page must be accessed from within Telegram.";
      document.body.innerHTML = '<h1>Error: Must be accessed from within Telegram.</h1>';
      return;
    }
    tg.ready();

    const addProjectForm = document.getElementById('add-project-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const formStatus = document.getElementById('form-status') as HTMLDivElement;

    async function uploadFile(file: File): Promise<string> {
      const response = await fetch('/api/profiles/upload', {
        method: 'POST', body: file, headers: { 'Content-Type': file.type, 'X-Bucket': 'project-images' }
      });
      if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Upload failed.');
      }
      return (await response.json()).url;
    }

    addProjectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      formStatus.textContent = 'Uploading image...';

      const imageInput = (e.target as HTMLFormElement).elements.namedItem('image') as HTMLInputElement;
      if (!imageInput.files || imageInput.files.length === 0) {
        alert('Please select a project image.');
        submitBtn.disabled = false;
        formStatus.textContent = '';
        return;
      }

      try {
        const imageUrl = await uploadFile(imageInput.files[0]);
        formStatus.textContent = 'Saving project...';
        
        const projectData = {
          initData: tg.initData,
          title: ((e.target as HTMLFormElement).elements.namedItem('title') as HTMLInputElement).value,
          description: ((e.target as HTMLFormElement).elements.namedItem('description') as HTMLTextAreaElement).value,
          image_url: imageUrl,
        };

        const response = await fetch('/api/projects/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(projectData),
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Failed to create project.');
        }

        alert('Project added successfully!');
        window.location.href = '/profile/edit'; // Redirect back to the main edit page
      } catch (err) {
        alert(`Error: ${(err as Error).message}`);
        submitBtn.disabled = false;
        formStatus.textContent = '';
      }
    });
  });
</script>
<style>
  .profile-page { max-width: 600px; margin: 0 auto; }
  .back-link-wrapper { margin-bottom: 2rem; }
  .back-link { display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; color: var(--hint-color); text-decoration: none; transition: color 0.2s; }
  .back-link:hover { color: var(--link-color); }
  .profile-form { display: flex; flex-direction: column; gap: 1rem; background-color: var(--secondary-bg-color); padding: 1.5rem; border-radius: 16px; margin-top: 1rem; }
  .profile-form label { font-weight: 500; display: flex; flex-direction: column; gap: 0.25rem; }
  .profile-form input, .profile-form textarea, .profile-form select { width: 100%; padding: 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); }
  .form-actions { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1rem; }
  .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none; }
  .btn-primary { background-color: var(--accent-color); color: var(--button-text-color); }
  #form-status { font-size: 0.9rem; color: var(--hint-color); text-align: right; flex-grow: 1; }
</style>