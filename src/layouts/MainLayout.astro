---
import '../styles/global.css';

interface Props {
	title: string;
}
const { title } = Astro.props;
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="ProfileHub Mini App" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
		<title>{title}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
	</head>
	<body>
		<main class="container">
      <slot /> 
    </main>
    
    <!-- !!! NEW: Both floating buttons are here, hidden by default !!! -->
    <a href="/me" class="fab fab-create" id="fab-create" style="display: none;">
      <span>Create Profile</span>
    </a>
    <a href="/edit" class="fab fab-edit" id="fab-edit" style="display: none;">
      <span>Edit Profile</span>
    </a>

    <script is:inline>
      // Function to check the user's profile status by calling our new API
      async function checkProfileStatus(initData) {
        const fabCreate = document.getElementById('fab-create');
        const fabEdit = document.getElementById('fab-edit');
        if (!fabCreate || !fabEdit) return;

        try {
          const response = await fetch('/api/profiles/me', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initData: initData }),
          });

          const data = await response.json();

          if (response.status === 404 && data.status === 'not_found') {
            // User does NOT have a profile, show "Create" button
            fabCreate.style.display = 'flex';
          } else if (response.status === 200 && data.status === 'found') {
            // User DOES have a profile, show "Edit" button
            fabEdit.style.display = 'flex';
          }
          
        } catch (error) {
          console.error('Failed to check profile status:', error);
          // Fallback: show the create button if the API fails
          fabCreate.style.display = 'flex';
        }
      }

      function setupTelegramIntegration() {
        try {
          const tg = window.Telegram.WebApp;
          tg.ready();
          
          const fabCreate = document.getElementById('fab-create');
          const fabEdit = document.getElementById('fab-edit');

          // Color the FABs with the theme colors
          const buttonColor = tg.themeParams.button_color || '#007aff';
          const textColor = tg.themeParams.button_text_color || '#ffffff';
          if (fabCreate) {
            fabCreate.style.backgroundColor = buttonColor;
            fabCreate.style.color = textColor;
          }
          if (fabEdit) {
            fabEdit.style.backgroundColor = buttonColor;
            fabEdit.style.color = textColor;
          }

          const applyTheme = () => { document.documentElement.className = tg.colorScheme; };
          tg.onEvent('themeChanged', applyTheme);
          applyTheme();

          // After setting up Telegram, check the user's profile status
          if (tg.initData) {
            checkProfileStatus(tg.initData);
          } else {
             // If not in Telegram, maybe show a login button or just create
             if(fabCreate) fabCreate.style.display = 'flex';
          }
          
        } catch (e) {
          console.warn('Telegram script not found or failed.');
          document.documentElement.className = 'light';
          // Show a fallback button for local dev
          const fabCreate = document.getElementById('fab-create');
          if(fabCreate) fabCreate.style.display = 'flex';
        }
      }

      // Run the main setup function
      setupTelegramIntegration();
    </script>
    <style is:global>
      .fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        height: 56px;
        border-radius: 28px;
        display: none; /* Both are hidden by default */
        align-items: center;
        justify-content: center;
        padding: 0 20px;
        gap: 8px;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        background-color: #007aff;
        color: #ffffff;
      }
    </style>
	</body>
</html>